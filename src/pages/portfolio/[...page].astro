---
import DefaultLayout from '@layouts/DefaultLayout.astro'
import PageHeader from '@components/PageHeader.astro'
import { Pagination } from 'accessible-astro-components'
import { getCollection } from 'astro:content'
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'

// No need to import images individually anymore - they're defined in each project's frontmatter

export const getStaticPaths = (async ({ paginate }) => {
  const projects = await getCollection('projects')

  // Sort projects by custom order field (lowest first), then by title if no order is set
  const sortedProjects = projects.sort((a, b) => {
    const orderA = a.data.order ?? 999 // Default to 999 if no order is set
    const orderB = b.data.order ?? 999

    // Sort by order ascending (lowest first)
    if (orderA !== orderB) {
      return orderA - orderB
    }

    // If orders are the same (or both undefined), sort by title ascending
    return a.data.title.localeCompare(b.data.title)
  })

  return paginate(sortedProjects, { pageSize: 6 })
}) satisfies GetStaticPaths

interface Props {
  page: Page<CollectionEntry<'projects'>>
}

const { page } = Astro.props

// Prepare pagination props
const currentPage = page.currentPage
const totalPages = Math.ceil(page.total / page.size)
---

<DefaultLayout
  title="Portfolio"
  description="A showcase of projects I've worked on, demonstrating my skills in turning in-depth data into meaningful, actionable insights by integrating coding skills with communications experience."
>
  <PageHeader
    title="portfolio"
    subtitle='A showcase of projects I have worked on, demonstrating my skills in turning in-depth data into meaningful, actionable insights by integrating coding skills with communications experience. See more of my journalism work on my <a href="https://www.houstonchronicle.com/author/anastasia-goodwin/">Houston Chronicle author page</a>.'
    bgType="bordered"
  />
  <!-- PUT THIS BACK WHEN PROJECTS IS GOOOOOD -->
  <section class="container my-8 lg:px-0">
    <p class="text-sm"><em>Project {page.start + 1} through {page.end + 1} of {page.total} total projects</em></p>
    {
      page.data.map((project) => (
        <article class="bottom-bordered flex flex-col gap-6 py-8 md:flex-row">
          <div class="md:w-1/3">
            <a
              href={project.data.live_url ? project.data.live_url : '/portfolio/' + project.id}
              target="_blank"
              rel="noopener noreferrer"
              class="block overflow-hidden"
            >
              {project.data.image ? (
                <img
                  src={project.data.image}
                  alt={`${project.data.title} project screenshot`}
                  class="h-full w-full object-cover"
                  loading="lazy"
                />
              ) : (
                <div class="flex h-full w-full items-center justify-center bg-gray-200 text-gray-500">
                  No image available
                </div>
              )}
            </a>
          </div>
          <div class="md:w-2/3">
            <div class="flex flex-col gap-4">
              <a
                href={project.data.live_url ? project.data.live_url : '/portfolio/' + project.id}
                target="_blank"
                rel="noopener noreferrer"
                class="group"
              >
                <h3 class="text-lg font-bold text-gray-900 sm:text-2xl">{project.data.title}</h3>
              </a>

              <div class="text-primary-600 text-sm font-bold">
                {(project.data.company || '').toUpperCase()} | {(project.data.pub_date || '').toUpperCase()}
              </div>

              <p class="text-sm">{project.data.description}</p>
              <p class="text-sm">{project.data.responsibilities}</p>
              {/* PROJECT TAGS */}
              {project.data.project_tags && (
                <div class="flex flex-wrap gap-2">
                  {project.data.project_tags.split(',').map((tag) => (
                    <span class="project-tag font-large dark:text-primary-300 rounded-full py-1 text-sm text-neutral-600">
                      {tag.trim()}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </div>
        </article>
      ))
    }
    <div class="mt-12 grid place-content-center">
      <Pagination
        firstPage={page.url.prev ? '/portfolio' : null}
        previousPage={page.url.prev ? page.url.prev : null}
        nextPage={page.url.next ? page.url.next : null}
        lastPage={page.url.next ? `/portfolio/${Math.ceil(page.total / page.size)}` : null}
        currentPage={`${page.currentPage}`}
        totalPages={`${Math.ceil(page.total / page.size)}`}
        ariaLabel="Portfolio pagination"
      />
    </div>
  </section>
</DefaultLayout>

<style lang="scss" is:global>
  @use '../../assets/scss/base/mixins' as *;

  main a {
    text-decoration: none;
    :hover {
      color: var(--color-primary-400);
    }
  }
  .project-tag {
    border-width: 2px;
    border-color: var(--color-neutral-600);
    padding: 0.25rem 0.75rem;
    color: var(--color-red-neutral-600);
    font-weight: 600;
  }
</style>
